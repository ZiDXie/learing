# CAN通信

## 接线方式

一根CAN_H一根CAN_L，不同设备的CAN_H和CAN_L各自接到一起，无需共地。差分信号通信，抗干扰能力强。

CAN控制器引出的TX和RX与CAN收发器相连，CAN收发器引出的CANH和CAN L分别与总线的CAN H和CANL相

连。

高速CAN规定：(隐性电平)电压差为0V时表示逻辑1电压差为2V时表示逻辑0(显性电平)

---



## can线特征

异步，无需时钟线，通信速率由设备各自约定

半双工，可挂载多设备，多设备同时发送数据时通过仲裁判断先后顺序

11位/29位报文ID，用于区分消息功能，同时决定优先级

可配置1~8字节的有效载荷

可实现广播式和请求式两种传输方式

---



## 帧的类型

![1738662855441](image/can/1738662855441.png)

## 数据帧

![1738663550865](image/can/1738663550865.png)

### 数据帧用途

* SOF（Startof Frame）：帧起始，表示后面一段波形为传输的数据位
* ID（Identify）：标识符，区分功能，同时决定优先级
* RTR（RemoteTransmission Request ）：远程请求位，区分数据帧和遥控帧
* IDE（IdentifierExtension）：扩展标志位，区分标准格式和扩展格式
* SRR（SubstituteRemote Request）：替代RTR，协议升级时留下的无意义位
* r0/r1（Reserve）：保留位，为后续协议升级留下空间
* DLC（DataLength Code）：数据长度，指示数据段有几个字节
* Data：数据段的1~8个字节有效数据
* CRC（CyclicRedundancy Check）：循环冗余校验，校验数据是否正确
* ACK（Acknowledgement）：应答位，判断数据有没有被接收方接收
* CRC/ACK界定符：为应答位前后发送方和接收方释放总线留下时间
* EOF（Endof Frame ）：帧结束，表示数据位已经传输完毕

### 遥控帧

![1739950410593](image/can/1739950410593.png)

遥控帧无数据段，RTR为隐性电平1，

### 错误帧

![1739950473151](image/can/1739950473151.png)

### 过载帧

当接收方收到大量数据而无法处理时，其可以发出过载帧，延缓发送方的数据发送，以平衡总线负载，避免数据丢失

![1739950525765](image/can/1739950525765.png)

## 位填充

位填充规则：发送方每发送5个相同电平后，自动追加一个相反电平的填充位，接收方检测到填充位时，会自动移除填充位，恢复原始数据

|                                                      |
| ---------------------------------------------------- |
| 即将发送：  100000110     10000011110  0111111111110 |
| 实际发送：  10000011101000001111100  011111011111010 |
| 实际接收：  10000011101000001111100  011111011111010 |
| 移除填充后100000110     10000011110  0111111111110   |

---



## 波特率计算

波特率 = 1 /一个数据位的时长

---



## 资源分配规则

### 先占先得

若当前已经有设备正在操作总线发送数据帧/遥控帧，则其他任何设备不能再同时发送数据帧/遥控帧（可以发送错误帧/过载帧破坏当前数据）

任何设备检测到连续11个隐性电平，即认为总线空闲，只有在总线空闲时，设备才能发送数据帧/遥控帧

一旦有设备正在发送数据帧/遥控帧，总线就会变为活跃状态，必然不会出现连续11个隐性电平，其他设备自然也不会破坏当前发送

若总线活跃状态其他设备有发送需求，则需要等待总线变为空闲，才能执行发送需求

### 非破坏性仲裁

若多个设备的发送需求同时到来或因等待而同时到来，则CAN总线协议会根据ID号（仲裁段）进行非破坏性仲裁，ID号小的（优先级高）取到总线控制权，ID号大的（优先级低）仲裁失利后将转入接收状态，等待下一次总线空闲时再尝试发送

实现非破坏性仲裁需要两个要求：

* 线与特性：总线上任何一个设备发送显性电平0时，总线就会呈现显性电平0状态，只有当所有设备都发送隐性电平1时，总线才呈现隐性电平1状态，即：
  ```
  0
  & X & X = 0，1
  & 1 & 1 = 1
  ```
* 回读机制：每个设备发出一个数据位后，都会读回总线当前的电平状态，以确认自己发出的电平是否被真实地发送出去了，根据线与特性，发出0读回必然是0，发出1读回不一定是1

---
